<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PRO 마케팅 프로세스 · Full Swimlane</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;

      --labelW:190px;
      --colW:240px;
      --gap:96px;
      --laneH:190px;

      --padX:24px;

      --diagramW:5200px;
      --diagramH:760px;

      --radius:16px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo",
                   "Noto Sans KR", "Segoe UI", Roboto, Helvetica, Arial, "Segoe UI Emoji";
      color:var(--text);
    }

    .wrap{
      width: 100%;
      max-width: none;
      margin: 0;
      padding: 28px 18px 40px;
    }

    .header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }
    .title{margin:0;font-size:22px;letter-spacing:-0.2px;}

    .diagramShell{
      margin-top:14px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      overflow:auto;
      box-shadow: 0 1px 2px rgba(15,23,42,.08);
    }

    .diagram{
      position:relative;
      width: var(--diagramW);
      height: var(--diagramH);
      background: var(--card);
    }

    .lane{
      display:grid;
      grid-template-columns: var(--labelW) 1fr;
      height: var(--laneH);
    }
    .lane:not(:last-child){ border-bottom: 1px solid #eef2f7; }

    .lane__label{
      padding:16px 14px;
      font-weight:900;
      font-size:13px;
      border-right: 1px solid var(--border);
      background: rgba(255,255,255,.55);
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:6px;
    }
    .lane__label small{
      display:block;
      font-weight:700;
      color:var(--muted);
      font-size:11px;
      line-height:1.35;
    }

    .lane__body{
      padding: 0 var(--padX);
      display:grid;
      grid-template-columns: repeat(15, var(--colW));
      column-gap: var(--gap);
      align-items:center;
    }

    .node{
      min-height:72px;
      padding:10px 12px;
      border:1px solid #d1d5db;
      border-radius: 12px;
      background:#fff;
      box-shadow: 0 1px 2px rgba(15,23,42,.08);
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      gap:6px;
      z-index:2;               /* ✅ 노드가 항상 위 */
      position:relative;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .node:hover{ transform: translateY(-1px); box-shadow: 0 6px 18px rgba(15,23,42,.10); border-color:#cbd5e1; }

    .node.system{
      border-color: rgba(14,165,233,.55);
      background: rgba(14,165,233,.06);
    }

    .node__title{
      font-size:12px;
      font-weight:950;
      line-height:1.25;
      letter-spacing:-0.15px;
      word-break:keep-all;
    }

    .node__meta{
      font-size:11px;
      color: var(--muted);
      line-height:1.25;
      word-break:keep-all;
      display:-webkit-box;
      -webkit-line-clamp:3;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }

    /* SVG (화살표) */
    #lines{
      position:absolute;
      left:0; top:0;
      width:100%;
      height:100%;
      pointer-events:none;
      z-index:1;               /* ✅ 항상 노드 뒤 */
    }
    .arrow{ stroke:#111827; stroke-width:2; fill:none; }
    .arrow.dashed{ stroke-dasharray: 6 5; stroke:#0ea5e9; }
    .arrow.faint{ stroke:#94a3b8; stroke-width:1.5; }

    /* Modal */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(15,23,42,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:100;
    }
    .modal{
      width:min(860px, 96vw);
      background:#fff;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.35);
      box-shadow: 0 16px 60px rgba(15,23,42,.35);
      overflow:hidden;
    }
    .modalHeader{
      padding:14px 16px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid #eef2f7;
    }
    .modalHeader h2{margin:0;font-size:15px;letter-spacing:-0.2px;}
    .modalHeader p{margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.5;}
    .closeBtn{
      border:1px solid #e5e7eb;
      background:#fff;
      border-radius:10px;
      padding:8px 12px;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      transition: background .12s ease;
    }
    .closeBtn:hover{background:#f8fafc}

    .modalBody{padding: 14px 16px;}
    .detailGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .detailCard{
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:12px 12px;
      background:#fff;
    }
    .detailCard h3{margin:0 0 6px;font-size:12px;letter-spacing:-0.15px;}
    .detailCard pre{margin:0;white-space:pre-wrap;font-family:inherit;font-size:12px;line-height:1.55;color:#0f172a;}
    .hint{margin-top:10px;color:var(--muted);font-size:11px;}

    @media (max-width: 720px){
      :root{ --labelW:160px; --colW:220px; --gap:72px; --laneH:210px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <!-- ✅ 제목만 -->
      <h1 class="title">PRO 마케팅 프로세스</h1>
    </div>

    <div class="diagramShell" aria-label="가로 스크롤 영역">
      <div class="diagram" id="diagram" role="img" aria-label="PRO 마케팅 프로세스 스윔레인 다이어그램">
        <svg id="lines" aria-hidden="true"></svg>

        <!-- (이하 고객/내부/시스템 동선은 원문 그대로) -->
        <section class="lane lane--customer" data-lane="customer">
          <div class="lane__label">고객 동선
            <small>광고주(몰어드민 사용자)가 신청부터 라이브/운영/정산/해지까지 경험하는 흐름</small>
          </div>
          <div class="lane__body">
            <!-- customer 1~15 그대로 -->
            <div class="node" data-key="customer-1" data-step="1" style="grid-column:1"><div class="node__title">1. 안내 수신 후 신청 진입</div><div class="node__meta">(알림톡) PRO 마케팅 소개 &amp; 가입 안내 수신</div></div>
            <div class="node" data-key="customer-2" data-step="2" style="grid-column:2"><div class="node__title">2. 신청/약관 동의</div><div class="node__meta">(몰어드민) PRO 마케팅 신청 &amp; 약관 동의</div></div>
            <div class="node" data-key="customer-3" data-step="3" style="grid-column:3"><div class="node__title">3. 신청 완료 확인</div><div class="node__meta">(알림톡) 신청완료 안내 수신</div></div>
            <div class="node" data-key="customer-4" data-step="4" style="grid-column:4"><div class="node__title">4. 업종 심사 결과 확인</div><div class="node__meta">(알림톡) 진행 불가 안내 수신(해당 시)</div></div>
            <div class="node" data-key="customer-5" data-step="5" style="grid-column:5"><div class="node__title">5. 카드 등록 진행(필요 시)</div><div class="node__meta">(몰어드민) 광고 정보 확인 &amp; 카드 등록 요청 / 기등록 안내, (알림톡) 카드등록 요청/기등록 카드 사용 안내 수신</div></div>
            <div class="node" data-key="customer-6" data-step="6" style="grid-column:6"><div class="node__title">6. 광고 자산 연동 요청/점검</div><div class="node__meta">(몰어드민) 광고 준비중 안내, (알림톡) 자산 연동 요청 안내 수신 또는 점검중 안내 수신</div></div>
            <div class="node" data-key="customer-7" data-step="7" style="grid-column:7"><div class="node__title">7. 후불 한도/세팅 안내 확인</div><div class="node__meta">(알림톡) 후불 한도 확정 &amp; 광고 세팅 안내 수신</div></div>
            <div class="node" data-key="customer-8" data-step="8" style="grid-column:8"><div class="node__title">8. 광고계정 생성 확인8. ㄱ8</div><div class="node__meta">(몰어드민) 광고 진행중 안내 &amp; 해지 버튼 노출</div></div>
            <div class="node" data-key="customer-9" data-step="9" style="grid-column:9"><div class="node__title">9. 광고 시작/세팅 내역 수신</div><div class="node__meta">(알림톡/이메일) 광고 시작 안내 &amp; 세팅 내역 수신</div></div>
            <div class="node" data-key="customer-10" data-step="10" style="grid-column:10"><div class="node__title">10. 운영 루틴 결과 수신</div><div class="node__meta">(알림톡/이메일) 광고 세팅 &amp; 필터링 내역 수신</div></div>
            <div class="node" data-key="customer-11" data-step="11" style="grid-column:11"><div class="node__title">11. 주간 보고서 수신</div><div class="node__meta">(알림톡/이메일) 광고보고서 수신</div></div>
            <div class="node" data-key="customer-12" data-step="12" style="grid-column:12"><div class="node__title">12. 월간 예산 반영 알림 수신</div><div class="node__meta">(알림톡) 후불 예산 반영 알림 수신</div></div>
            <div class="node" data-key="customer-13" data-step="13" style="grid-column:13"><div class="node__title">13. 한도 재산정(증/감액) 대응</div><div class="node__meta">증액 시: (몰어드민) 부속합의 요청/완료 내역 확인 + (알림톡) 증액&amp;일예산 조정 안내 수신 / 감액 시: (알림톡) 감액 적용 안내 수신</div></div>
            <div class="node" data-key="customer-14" data-step="14" style="grid-column:14"><div class="node__title">14. 후불 정산/미수금 확인</div><div class="node__meta">(몰어드민) 정산 금액/PG차감/미수금/카드결제 내역 확인, (알림톡) 정산 예정/차감/미수금/실패&amp;중단/채권추심 안내 수신</div></div>
            <div class="node" data-key="customer-15" data-step="15" style="grid-column:15"><div class="node__title">15. 해지 요청/완료</div><div class="node__meta">(몰어드민) 1:1 문의/CTI 접수 → 해지&amp;정산 안내/완료 확인, (알림톡) 정산완료&amp;해지완료 수신</div></div>
          </div>
        </section>

        <section class="lane lane--ops" data-lane="ops">
          <div class="lane__label">내부 사용자 동선
            <small>운영자/마케팅센터가 신청 접수부터 세팅/운영/정산/해지까지 처리하는 흐름</small>
          </div>
          <div class="lane__body">
            <!-- ops 1~15 그대로 -->
            <div class="node" data-key="ops-1" data-step="1" style="grid-column:1"><div class="node__title">1. 대상자 선별/안내 발송</div><div class="node__meta">(운영/시스템) 알림 발송 운영</div></div>
            <div class="node" data-key="ops-2" data-step="2" style="grid-column:2"><div class="node__title">2. 신청 접수 관리</div><div class="node__meta">(FAS) PRO 마케팅 신청 접수</div></div>
            <div class="node" data-key="ops-3" data-step="3" style="grid-column:3"><div class="node__title">3. 업종 심사</div><div class="node__meta">(심사 프로세스)</div></div>
            <div class="node" data-key="ops-4" data-step="4" style="grid-column:4"><div class="node__title">4. 카드 등록 상태 관리</div><div class="node__meta">(상태 확인)</div></div>
            <div class="node" data-key="ops-5" data-step="5" style="grid-column:5"><div class="node__title">5. 담당자 지정</div><div class="node__meta">(운영자) 담당자 지정</div></div>
            <div class="node" data-key="ops-6" data-step="6" style="grid-column:6"><div class="node__title">6. 광고 자산 연동(미연동 시)</div><div class="node__meta">(운영자) CMC 매체별 광고 신청</div></div>
            <div class="node" data-key="ops-7" data-step="7" style="grid-column:7"><div class="node__title">7. 후불 한도 확정</div><div class="node__meta">(운영자) 후불 한도 확정</div></div>
            <div class="node" data-key="ops-8" data-step="8" style="grid-column:8"><div class="node__title">8. 후불 예산 반영</div><div class="node__meta">(운영자) 후불 예산 반영</div></div>
            <div class="node" data-key="ops-9" data-step="9" style="grid-column:9"><div class="node__title">9. 차마솔 계정/시나리오 설정</div><div class="node__meta">(운영자) 차마솔 계정 등록 &amp; 시나리오 설정</div></div>
            <div class="node" data-key="ops-10" data-step="10" style="grid-column:10"><div class="node__title">10. 세팅 검수 &amp; 광고 ON</div><div class="node__meta">(운영자) 세팅 결과 검수 &amp; ON</div></div>
            <div class="node" data-key="ops-11" data-step="11" style="grid-column:11"><div class="node__title">11. 보고서 세팅</div><div class="node__meta">(운영자) CMC 광고보고서 세팅</div></div>
            <div class="node" data-key="ops-12" data-step="12" style="grid-column:12"><div class="node__title">12. 월간 예산 루틴 반영</div><div class="node__meta">(운영자) 월간 예산 반영 대상 확인/반영</div></div>
            <div class="node" data-key="ops-13" data-step="13" style="grid-column:13"><div class="node__title">13. 한도 재산정/증액 처리</div><div class="node__meta">(운영자) 재산정 결과 반영, 증액 적용</div></div>
            <div class="node" data-key="ops-14" data-step="14" style="grid-column:14"><div class="node__title">14. 정산/미수금/추심</div><div class="node__meta">(운영자) 미수금 대상 확인, 광고 중단 처리, 추심 절차 진행</div></div>
            <div class="node" data-key="ops-15" data-step="15" style="grid-column:15"><div class="node__title">15. 해지 처리</div><div class="node__meta">(운영자) 해지 요청 확인/해지 처리</div></div>
          </div>
        </section>

        <section class="lane lane--system" data-lane="system">
          <div class="lane__label">시스템 동선
            <small>사람 작업과 별개로 시스템이 자동으로 수행/발송/판단하는 흐름(자동 노드)</small>
          </div>
          <div class="lane__body">
            <div class="node system" data-key="system-1" data-step="1" style="grid-column:1"><div class="node__title">대상자 선별 &amp; 알림톡 발송</div><div class="node__meta">AUTO</div></div>
            <div class="node system" data-key="system-3" data-step="3" style="grid-column:3"><div class="node__title">신청 접수 상태 관리(FAS 연계)</div><div class="node__meta">AUTO</div></div>
            <div class="node system" data-key="system-4" data-step="4" style="grid-column:4"><div class="node__title">업종 심사 결과 반영 및 진행불가 알림 발송</div><div class="node__meta">AUTO</div></div>
            <div class="node system" data-key="system-5" data-step="5" style="grid-column:5"><div class="node__title">카드 등록 상태 체크 &amp; 리마인드 발송</div><div class="node__meta">AUTO</div></div>
            <div class="node system" data-key="system-6" data-step="6" style="grid-column:6"><div class="node__title">광고자산 연동 상태 체크 &amp; 요청/점검 알림</div><div class="node__meta">AUTO</div></div>
            <div class="node system" data-key="system-9" data-step="9" style="grid-column:9"><div class="node__title">차마솔 광고 세팅 자동 수행</div><div class="node__meta">AUTO</div></div>
            <div class="node system" data-key="system-10" data-step="10" style="grid-column:10"><div class="node__title">차마솔 시나리오 정기 실행(운영 루틴)</div><div class="node__meta">AUTO</div></div>
            <div class="node system" data-key="system-11" data-step="11" style="grid-column:11"><div class="node__title">CMC 광고보고서 주간 생성(리포트 루틴)</div><div class="node__meta">AUTO</div></div>
            <div class="node system" data-key="system-14" data-step="14" style="grid-column:14"><div class="node__title">후불 정산 금액 산정(월 2회) &amp; PG차감/미수금 분기 + 카드결제 성공/실패 처리</div><div class="node__meta">AUTO</div></div>
          </div>
        </section>

        <section class="lane lane--contract" data-lane="contract">
          <div class="lane__label">후불계약 동선
            <small>후불 과금/한도/예산/정산/미수금/부속합의 중심 흐름</small>
          </div>
          <div class="lane__body">
            <!-- ✅ 균등 간격: [1,2,4,5,7,8,9,11,12,14,15] -->
            <div class="node" data-key="contract-1" data-step="1" style="grid-column:1"><div class="node__title">1. 가입/동의 기반 형성</div><div class="node__meta">PRO 마케팅 신청 &amp; 약관 동의(신청 자격 충족 시)</div></div>
            <div class="node" data-key="contract-2" data-step="2" style="grid-column:2"><div class="node__title">2. 결제수단 확보</div><div class="node__meta">카드 등록(미등록 시 등록 요청) / 기등록 카드 확인</div></div>
            <div class="node" data-key="contract-3" data-step="3" style="grid-column:4"><div class="node__title">3. 한도 확정</div><div class="node__meta">“후불 한도 확정 &amp; 광고 세팅 안내” 수신</div></div>
            <div class="node" data-key="contract-4" data-step="4" style="grid-column:5"><div class="node__title">4. 예산 반영</div><div class="node__meta">(알림으로 반영 결과 확인)</div></div>
            <div class="node" data-key="contract-5" data-step="5" style="grid-column:7"><div class="node__title">5. 월간 예산 반영(루틴)</div><div class="node__meta">“후불 예산 반영 알림” 수신</div></div>
            <div class="node" data-key="contract-6" data-step="6" style="grid-column:8"><div class="node__title">6. 한도 재산정(월 1회)</div><div class="node__meta">감액: 감액 적용 안내 수신 / 증액: 부속합의 요청 확인</div></div>
            <div class="node" data-key="contract-7" data-step="7" style="grid-column:9"><div class="node__title">7. 증액 시 부속합의</div><div class="node__meta">(몰어드민) 부속합의 요청 → 동의 → 완료 내역 확인</div></div>
            <div class="node" data-key="contract-8" data-step="8" style="grid-column:11"><div class="node__title">8. 일예산 조정</div><div class="node__meta">증액&amp;일예산 조정 안내 수신</div></div>
            <div class="node" data-key="contract-9" data-step="9" style="grid-column:12"><div class="node__title">9. 정산(월 2회)</div><div class="node__meta">정산 예정 안내 수신, PG차감/미수금 내역 확인</div></div>
            <div class="node" data-key="contract-10" data-step="10" style="grid-column:14"><div class="node__title">10. 미수금 처리</div><div class="node__meta">카드결제 안내 수신 또는 실패&amp;광고중단/추심 안내 수신</div></div>
            <div class="node" data-key="contract-11" data-step="11" style="grid-column:15"><div class="node__title">11. 해지 시 정산 완료</div><div class="node__meta">해지&amp;정산 완료 확인, 완료 알림 수신</div></div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalBackdrop" id="backdrop" role="dialog" aria-modal="true" aria-label="노드 상세 정보">
    <div class="modal">
      <div class="modalHeader">
        <div>
          <h2 id="modalTitle">상세</h2>
          <p id="modalSubtitle"></p>
        </div>
        <button class="closeBtn" id="closeBtn" type="button">닫기</button>
      </div>
      <div class="modalBody">
        <div class="detailGrid" id="detailGrid"></div>
        <div class="hint">※ 노드 텍스트는 3줄 프리뷰로 높이를 맞췄습니다. 원문 전체는 이 상세에서 확인할 수 있어요.</div>
      </div>
    </div>
  </div>

  <script>
  /* ✅ nodeDetails는 사용자가 준 그대로(생략 없이 붙여도 OK) */
  const nodeDetails = window.nodeDetails || {}; // (원본 데이터를 그대로 쓰는 경우 window.nodeDetails로 넣어도 됨)

  const diagram = document.getElementById('diagram');
  const svg = document.getElementById('lines');
  const backdrop = document.getElementById('backdrop');
  const closeBtn = document.getElementById('closeBtn');
  const modalTitle = document.getElementById('modalTitle');
  const modalSubtitle = document.getElementById('modalSubtitle');
  const detailGrid = document.getElementById('detailGrid');

  function ensureDefs() {
    if (svg.querySelector('defs')) return;
    const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');

    function mkMarker(id, color){
      const marker = document.createElementNS('http://www.w3.org/2000/svg','marker');
      marker.setAttribute('id', id);
      marker.setAttribute('markerWidth','10');
      marker.setAttribute('markerHeight','8');
      marker.setAttribute('refX','9');
      marker.setAttribute('refY','4');
      marker.setAttribute('orient','auto');
      const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
      poly.setAttribute('points','0,0 10,4 0,8');
      poly.setAttribute('fill', color);
      marker.appendChild(poly);
      defs.appendChild(marker);
    }
    mkMarker('arrowhead', '#111827');
    mkMarker('arrowheadBlue', '#0ea5e9');
    mkMarker('arrowheadFaint', '#94a3b8');

    svg.appendChild(defs);
  }

  function clearSvgPathsOnly(){
    [...svg.querySelectorAll('path')].forEach(p => p.remove()); // ✅ defs는 유지
  }

  function markerFor(cls){
    if ((cls||'').includes('dashed')) return 'url(#arrowheadBlue)';
    if ((cls||'').includes('faint')) return 'url(#arrowheadFaint)';
    return 'url(#arrowhead)';
  }

  function getLaneNodes(laneName) {
    const lane = diagram.querySelector(`.lane[data-lane="${laneName}"] .lane__body`);
    if (!lane) return [];
    const nodes = [...lane.querySelectorAll('.node')];
    return nodes
      .map(n => ({ el:n, step: Number(n.dataset.step || '0') }))
      .filter(x => x.step > 0)
      .sort((a,b)=>a.step-b.step);
  }

  function getNodeElByKey(key) {
    return diagram.querySelector(`.node[data-key="${key}"]`);
  }

  function rectInDiagram(el, diagramRect){
    const r = el.getBoundingClientRect();
    return {
      left: r.left - diagramRect.left,
      right: r.right - diagramRect.left,
      top: r.top - diagramRect.top,
      bottom: r.bottom - diagramRect.top,
      cx: (r.left + r.right)/2 - diagramRect.left,
      cy: (r.top + r.bottom)/2 - diagramRect.top
    };
  }

  function laneRectInDiagram(el, diagramRect){
    const lane = el.closest('.lane');
    const r = lane.getBoundingClientRect();
    return { top: r.top - diagramRect.top, bottom: r.bottom - diagramRect.top };
  }

  /* ✅ 같은 레인: “노드 아래 공간의 중간” 라인으로만 연결 */
  function laneFlow(fromEl, toEl, cls){
    const diagramRect = diagram.getBoundingClientRect();
    const a = rectInDiagram(fromEl, diagramRect);
    const b = rectInDiagram(toEl, diagramRect);
    const laneR = laneRectInDiagram(fromEl, diagramRect);

    const y = Math.min(
      a.bottom + (laneR.bottom - a.bottom) * 0.55,
      laneR.bottom - 14
    );

    const x1 = a.right + 6;
    const x2 = b.left - 8;

    const dist = Math.abs(x2 - x1);
    const dx = Math.max(36, Math.min(180, dist * 0.35));

    const p = document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('d', `M ${x1} ${y} C ${x1+dx} ${y}, ${x2-dx} ${y}, ${x2} ${y}`);
    p.setAttribute('class', cls);
    p.setAttribute('marker-end', markerFor(cls));
    svg.appendChild(p);
  }

  /* ✅ 레인 간: 대각선 금지(노드 관통 방지), 레인 사이 빈 공간으로 ㄱ자 라우팅 */
  function crossLane(fromEl, toEl, cls){
    const diagramRect = diagram.getBoundingClientRect();
    const a = rectInDiagram(fromEl, diagramRect);
    const b = rectInDiagram(toEl, diagramRect);

    const la = laneRectInDiagram(fromEl, diagramRect);
    const lb = laneRectInDiagram(toEl, diagramRect);

    const down = b.cy >= a.cy;
    const viaY = down ? (la.bottom + lb.top)/2 : (lb.bottom + la.top)/2;

    const startX = a.cx;
    const endX = b.cx;
    const startY = down ? (a.bottom + 6) : (a.top - 6);
    const endY   = down ? (b.top - 6) : (b.bottom + 6);

    const p = document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('d', `M ${startX} ${startY} L ${startX} ${viaY} L ${endX} ${viaY} L ${endX} ${endY}`);
    p.setAttribute('class', cls);
    p.setAttribute('marker-end', markerFor(cls));
    svg.appendChild(p);
  }

  function drawEdge(fromKey, toKey, cls='arrow'){
    const from = getNodeElByKey(fromKey);
    const to = getNodeElByKey(toKey);
    if(!from || !to) return;

    const fromLane = from.closest('.lane')?.dataset?.lane;
    const toLane = to.closest('.lane')?.dataset?.lane;

    if(fromLane && toLane && fromLane === toLane) laneFlow(from, to, cls);
    else crossLane(from, to, cls);
  }

  function computeDiagramSize() {
    const st = getComputedStyle(document.documentElement);
    const cols = 15;
    const labelW = parseFloat(st.getPropertyValue('--labelW')) || 190;
    const colW = parseFloat(st.getPropertyValue('--colW')) || 240;
    const gap  = parseFloat(st.getPropertyValue('--gap'))  || 96;
    const padX = parseFloat(st.getPropertyValue('--padX')) || 24;
    const laneH = parseFloat(st.getPropertyValue('--laneH')) || 190;
    const laneCount = diagram.querySelectorAll('.lane').length;
    const w = labelW + (padX*2) + (colW*cols) + (gap*(cols-1)) + 24;
    const h = laneH * laneCount;
    diagram.style.width = `${Math.ceil(w)}px`;
    diagram.style.height = `${Math.ceil(h)}px`;
  }

  function draw(){
    ensureDefs();
    svg.setAttribute('width', diagram.clientWidth);
    svg.setAttribute('height', diagram.clientHeight);
    svg.setAttribute('viewBox', `0 0 ${diagram.clientWidth} ${diagram.clientHeight}`);
    clearSvgPathsOnly();

    // 레인 내 순차 연결
    const lanes = [
      { name:'customer', cls:'arrow' },
      { name:'ops', cls:'arrow' },
      { name:'system', cls:'arrow dashed' },
      { name:'contract', cls:'arrow' }
    ];

    lanes.forEach(l => {
      const list = getLaneNodes(l.name);
      for(let i=0;i<list.length-1;i++){
        laneFlow(list[i].el, list[i+1].el, l.cls);
      }
    });

    // 핵심 트리거 연결(레인 간은 ㄱ자)
    drawEdge('system-1','customer-1','arrow dashed');
    drawEdge('system-1','ops-1','arrow dashed');
    drawEdge('customer-2','ops-2','arrow faint');
    drawEdge('customer-2','system-3','arrow dashed');
    drawEdge('ops-2','system-3','arrow dashed');
    drawEdge('system-3','customer-3','arrow dashed');
    drawEdge('ops-3','system-4','arrow dashed');
    drawEdge('system-4','customer-4','arrow dashed');
    drawEdge('system-5','customer-5','arrow dashed');
    drawEdge('system-5','ops-4','arrow dashed');
    drawEdge('customer-5','ops-4','arrow faint');
    drawEdge('customer-5','system-5','arrow dashed');
    drawEdge('ops-6','system-6','arrow dashed');
    drawEdge('system-6','customer-6','arrow dashed');
    drawEdge('system-6','ops-6','arrow dashed');
    drawEdge('customer-6','system-6','arrow dashed');
    drawEdge('ops-7','customer-7','arrow');
    drawEdge('ops-7','contract-3','arrow');
    drawEdge('ops-8','contract-4','arrow');
    drawEdge('ops-8','customer-7','arrow faint');
    drawEdge('ops-9','system-9','arrow dashed');
    drawEdge('ops-10','system-9','arrow dashed');
    drawEdge('system-9','customer-9','arrow dashed');
    drawEdge('ops-10','customer-8','arrow');
    drawEdge('system-10','customer-10','arrow dashed');
    drawEdge('system-11','customer-11','arrow dashed');
    drawEdge('ops-12','customer-12','arrow');
    drawEdge('ops-12','contract-5','arrow');
    drawEdge('ops-13','customer-13','arrow');
    drawEdge('ops-13','contract-6','arrow');
    drawEdge('ops-13','contract-7','arrow faint');
    drawEdge('customer-13','contract-7','arrow faint');
    drawEdge('system-14','customer-14','arrow dashed');
    drawEdge('system-14','ops-14','arrow dashed');
    drawEdge('system-14','contract-9','arrow dashed');
    drawEdge('system-14','contract-10','arrow dashed');
    drawEdge('customer-15','ops-15','arrow');
    drawEdge('ops-15','contract-11','arrow');
    drawEdge('customer-15','contract-11','arrow faint');
  }

  function openModal(key) {
    const data = nodeDetails[key];
    if (!data) return;
    modalTitle.textContent = data.title || '상세';
    modalSubtitle.textContent = data.subtitle || '';
    detailGrid.innerHTML = '';

    (data.details || []).forEach(d => {
      const card = document.createElement('div');
      card.className = 'detailCard';
      const h = document.createElement('h3');
      h.textContent = d.title || '';
      const pre = document.createElement('pre');
      pre.textContent = d.content || '';
      card.appendChild(h);
      card.appendChild(pre);
      detailGrid.appendChild(card);
    });

    backdrop.style.display = 'flex';
  }
  function closeModal(){ backdrop.style.display = 'none'; }

  diagram.addEventListener('click', (e) => {
    const node = e.target.closest('.node');
    if (!node) return;
    openModal(node.dataset.key);
  });
  closeBtn.addEventListener('click', closeModal);
  backdrop.addEventListener('click', (e) => { if (e.target === backdrop) closeModal(); });
  window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

  function rerender(){
    computeDiagramSize();
    // ✅ 레이아웃 확정 후 그리기(화살표 “사라짐” 방지)
    requestAnimationFrame(() => requestAnimationFrame(draw));
  }

  window.addEventListener('load', rerender);
  window.addEventListener('resize', rerender);
  </script>
</body>
</html>
