<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta content="width=device-width, initial-scale=1" name="viewport" />
<title>PRO 마케팅 프로세스 · Full Swimlane</title>
<style>
  :root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --text:#0f172a;
    --muted:#64748b;
    --border:#e5e7eb;

    /* 레이아웃 */
    --labelW:190px;
    --colW:240px;
    --gap:110px;          /* ✅ 후불 연결이 길면 이 값을 더 키우면 됨 */
    --laneH:190px;
    --padX:24px;

    --radius:16px;
  }

  *{box-sizing:border-box}
  html, body{width:100%;}
  body{
    margin:0;
    background:var(--bg);
    font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo",
                 "Noto Sans KR", "Segoe UI", Roboto, Helvetica, Arial, "Segoe UI Emoji";
    color:var(--text);
  }

  .wrap{
    width:100%;
    margin:0;
    padding: 28px 24px 40px;
  }

  .header{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:16px;
    margin-bottom:14px;
    flex-wrap:wrap;
  }
  .title{margin:0;font-size:22px;letter-spacing:-0.2px;}
  .subtitle{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.5;max-width:980px;}

  .legend{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
  .legend span{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;
    background:rgba(255,255,255,.65);border:1px solid rgba(148,163,184,.35);font-size:12px;color:#334155;
  }
  .dot{width:10px;height:10px;border-radius:999px;background:#111827;}
  .dot.system{background:#0ea5e9;}

  /* 스크롤 컨테이너 */
  .diagramShell{
    margin-top:14px;
    border:1px solid var(--border);
    border-radius: var(--radius);
    background: var(--card);
    overflow:auto;
    box-shadow: 0 1px 2px rgba(15,23,42,.08);
  }

  .diagram{
    position:relative;
    background: var(--card);
    /* width는 JS가 계산해서 inline으로 넣음 */
  }

  .lane{
    display:grid;
    grid-template-columns: var(--labelW) 1fr;
    height: var(--laneH);
  }
  .lane:not(:last-child){ border-bottom: 1px solid #eef2f7; }

  .lane__label{
    padding:16px 14px;
    font-weight:900;
    font-size:13px;
    border-right: 1px solid var(--border);
    background: rgba(255,255,255,.55);
    display:flex;
    flex-direction:column;
    align-items:flex-start;
    gap:6px;
  }
  .lane__label small{
    display:block;
    font-weight:700;
    color:var(--muted);
    font-size:11px;
    line-height:1.35;
  }

  .lane__body{
    padding: 0 var(--padX);
    display:grid;
    grid-template-columns: repeat(15, var(--colW));
    column-gap: var(--gap);
    align-items:center;
  }

  .node{
    height:84px;
    padding:10px 12px;
    border:1px solid #d1d5db;
    border-radius: 12px;
    background:#fff;
    box-shadow: 0 1px 2px rgba(15,23,42,.08);
    display:flex;
    flex-direction:column;
    justify-content:flex-start;
    gap:6px;
    z-index:2;
    position:relative;
    cursor:pointer;
    transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
  }
  .node:hover{ transform: translateY(-1px); box-shadow: 0 6px 18px rgba(15,23,42,.10); border-color:#cbd5e1; }

  .node.system{
    border-color: rgba(14,165,233,.55);
    background: rgba(14,165,233,.06);
  }

  .node__title{
    font-size:12px;
    font-weight:950;
    line-height:1.25;
    letter-spacing:-0.15px;
    word-break:keep-all;
  }
  .node__meta{
    font-size:11px;
    color: var(--muted);
    line-height:1.25;
    word-break:keep-all;
    display:-webkit-box;
    -webkit-line-clamp:3;
    -webkit-box-orient:vertical;
    overflow:hidden;
  }

  /* SVG (화살표) */
  #lines{
    position:absolute;
    left:0; top:0;
    width:100%;
    height:100%;
    pointer-events:none;
    z-index:1;
  }
  .arrow{ stroke:#111827; stroke-width:2; fill:none; }
  .arrow.dashed{ stroke-dasharray: 6 5; stroke:#0ea5e9; }
  .arrow.faint{ stroke:#94a3b8; stroke-width:1.5; }
  .arrow.alert{ stroke:#ef4444; stroke-width:2.2; } /* 필요 시 강조용 */

  /* Modal */
  .modalBackdrop{
    position:fixed; inset:0;
    background: rgba(15,23,42,.55);
    display:none;
    align-items:center;
    justify-content:center;
    padding:20px;
    z-index:100;
  }
  .modalBackdrop.show{display:flex;}
  .modal{
    width:min(900px, 96vw);
    background:#fff;
    border-radius:16px;
    border:1px solid rgba(148,163,184,.35);
    box-shadow: 0 16px 60px rgba(15,23,42,.35);
    overflow:hidden;
  }
  .modalHeader{
    padding:14px 16px;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    border-bottom:1px solid #eef2f7;
  }
  .modalHeader h2{margin:0;font-size:15px;letter-spacing:-0.2px;}
  .modalHeader p{margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.5;}
  .closeBtn{
    border:1px solid #e5e7eb;
    background:#fff;
    border-radius:10px;
    padding:8px 12px;
    font-weight:900;
    font-size:13px;
    cursor:pointer;
    transition: background .12s ease;
  }
  .closeBtn:hover{background:#f8fafc}

  .modalBody{padding: 14px 16px;}
  .detailGrid{
    display:grid;
    grid-template-columns: 1fr;
    gap:10px;
  }
  .detailCard{
    border:1px solid #e5e7eb;
    border-radius:14px;
    padding:12px 12px;
    background:#fff;
  }
  .detailCard h3{margin:0 0 6px;font-size:12px;letter-spacing:-0.15px;}
  .detailCard pre{margin:0;white-space:pre-wrap;font-family:inherit;font-size:12px;line-height:1.55;color:#0f172a;}

  @media (max-width: 720px){
    :root{ --labelW:160px; --colW:220px; --gap:84px; --laneH:210px; }
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="header">
    <div>
      <h1 class="title">PRO 마케팅 프로세스 · 신청 → 운영/정산 → 해지</h1>
      <p class="subtitle">
        고객(몰어드민) / 운영자(마케팅센터) / 시스템 자동 / 후불계약 관점 4개 레인. <br/>
        ✅ 화살표는 “고정 좌표”가 아닌 실제 노드 위치를 기준으로 매번 다시 그려서, 방향/끝점이 정확히 노드를 가리키고 노드 아래로 지나가도록 처리했습니다.
      </p>
    </div>
    <div class="legend" aria-label="범례">
      <span><span class="dot"></span>사용자/운영자 노드</span>
      <span><span class="dot system"></span>시스템 자동 노드</span>
    </div>
  </div>

  <div class="diagramShell" aria-label="가로 스크롤 영역">
    <div class="diagram" id="diagram" aria-label="PRO 마케팅 프로세스 스윔레인 다이어그램" role="img">
      <svg id="lines" aria-hidden="true">
        <defs>
          <marker id="arrowhead" markerheight="8" markerwidth="10" orient="auto" refx="9" refy="4">
            <polygon fill="#111827" points="0,0 10,4 0,8"></polygon>
          </marker>
          <marker id="arrowheadBlue" markerheight="8" markerwidth="10" orient="auto" refx="9" refy="4">
            <polygon fill="#0ea5e9" points="0,0 10,4 0,8"></polygon>
          </marker>
          <marker id="arrowheadFaint" markerheight="8" markerwidth="10" orient="auto" refx="9" refy="4">
            <polygon fill="#94a3b8" points="0,0 10,4 0,8"></polygon>
          </marker>
          <marker id="arrowheadAlert" markerheight="8" markerwidth="10" orient="auto" refx="9" refy="4">
            <polygon fill="#ef4444" points="0,0 10,4 0,8"></polygon>
          </marker>
        </defs>
      </svg>

      <!-- 1) 고객 동선 -->
      <section class="lane lane--customer" data-lane="customer">
        <div class="lane__label">고객 동선
          <small>광고주(몰어드민 사용자)가 신청부터 라이브/운영/정산/해지까지 경험하는 흐름</small>
        </div>
        <div class="lane__body">
          <div class="node" data-key="customer-1" style="grid-column:1">
            <div class="node__title">1. 안내 수신 후 신청 진입</div>
            <div class="node__meta">(알림톡) PRO 마케팅 소개 & 가입 안내 수신</div>
          </div>
          <div class="node" data-key="customer-2" style="grid-column:2">
            <div class="node__title">2. 신청/약관 동의</div>
            <div class="node__meta">(몰어드민) PRO 마케팅 신청 & 약관 동의</div>
          </div>
          <div class="node" data-key="customer-3" style="grid-column:3">
            <div class="node__title">3. 신청 완료 확인</div>
            <div class="node__meta">(알림톡) 신청완료 안내 수신</div>
          </div>
          <div class="node" data-key="customer-4" style="grid-column:4">
            <div class="node__title">4. 업종 심사 결과 확인</div>
            <div class="node__meta">(알림톡) 진행 불가 안내 수신(해당 시)</div>
          </div>
          <div class="node" data-key="customer-5" style="grid-column:5">
            <div class="node__title">5. 카드 등록 진행(필요 시)</div>
            <div class="node__meta">(몰어드민) 광고 정보 확인 & 카드 등록 요청/기등록 안내 + (알림톡) 카드등록 요청/기등록 카드 사용 안내</div>
          </div>
          <div class="node" data-key="customer-6" style="grid-column:6">
            <div class="node__title">6. 광고 자산 연동 요청/점검</div>
            <div class="node__meta">(몰어드민) 광고 준비중 안내 + (알림톡) 자산 연동 요청 또는 점검중 안내</div>
          </div>
          <div class="node" data-key="customer-7" style="grid-column:7">
            <div class="node__title">7. 후불 한도/세팅 안내 확인</div>
            <div class="node__meta">(알림톡) 후불 한도 확정 & 광고 세팅 안내 수신</div>
          </div>
          <div class="node" data-key="customer-8" style="grid-column:8">
            <div class="node__title">8. 광고계정 생성 확인</div>
            <div class="node__meta">(몰어드민) 광고계정 생성 완료 확인 & 해지 버튼 노출</div>
          </div>
          <div class="node" data-key="customer-9" style="grid-column:9">
            <div class="node__title">9. 광고 시작/세팅 내역 수신</div>
            <div class="node__meta">(알림톡/이메일) 광고 시작 안내 & 세팅 내역 수신</div>
          </div>
          <div class="node" data-key="customer-10" style="grid-column:10">
            <div class="node__title">10. 운영 루틴 결과 수신</div>
            <div class="node__meta">(알림톡/이메일) 광고 세팅 & 필터링 내역 수신</div>
          </div>
          <div class="node" data-key="customer-11" style="grid-column:11">
            <div class="node__title">11. 주간 보고서 수신</div>
            <div class="node__meta">(알림톡/이메일) 광고보고서 수신</div>
          </div>
          <div class="node" data-key="customer-12" style="grid-column:12">
            <div class="node__title">12. 월간 예산 반영 알림 수신</div>
            <div class="node__meta">(알림톡) 후불 예산 반영 알림 수신</div>
          </div>
          <div class="node" data-key="customer-13" style="grid-column:13">
            <div class="node__title">13. 한도 재산정(증/감액) 대응</div>
            <div class="node__meta">증액: (몰어드민) 부속합의 요청/완료 확인 + (알림톡) 증액&일예산 조정 / 감액: 감액 적용 안내</div>
          </div>
          <div class="node" data-key="customer-14" style="grid-column:14">
            <div class="node__title">14. 후불 정산/미수금 확인</div>
            <div class="node__meta">(몰어드민) 정산 금액/PG차감/미수금/카드결제 내역 확인 + (알림톡) 정산/미수금/실패&중단/추심 안내</div>
          </div>
          <div class="node" data-key="customer-15" style="grid-column:15">
            <div class="node__title">15. 해지 요청/완료</div>
            <div class="node__meta">(몰어드민) 1:1 문의/CTI → 해지&정산 안내/완료 + (알림톡) 정산완료&해지완료</div>
          </div>
        </div>
      </section>

      <!-- 2) 내부 사용자 동선 -->
      <section class="lane lane--ops" data-lane="ops">
        <div class="lane__label">내부 사용자 동선
          <small>운영자/마케팅센터가 신청 접수부터 세팅/운영/정산/해지까지 처리하는 흐름</small>
        </div>
        <div class="lane__body">
          <div class="node" data-key="ops-1" style="grid-column:1">
            <div class="node__title">1. 대상자 선별/안내 발송</div>
            <div class="node__meta">(운영/시스템) 알림 발송 운영</div>
          </div>
          <div class="node" data-key="ops-2" style="grid-column:2">
            <div class="node__title">2. 신청 접수 관리</div>
            <div class="node__meta">(FAS) PRO 마케팅 신청 접수</div>
          </div>
          <div class="node" data-key="ops-3" style="grid-column:3">
            <div class="node__title">3. 업종 심사</div>
            <div class="node__meta">ANPL팀 심사/판정</div>
          </div>
          <div class="node" data-key="ops-4" style="grid-column:4">
            <div class="node__title">4. 카드 등록 상태 관리</div>
            <div class="node__meta">카드 등록여부 상태 관리/리마인드</div>
          </div>
          <div class="node" data-key="ops-5" style="grid-column:5">
            <div class="node__title">5. 담당자 지정</div>
            <div class="node__meta">담당자 매핑/배정</div>
          </div>
          <div class="node" data-key="ops-6" style="grid-column:6">
            <div class="node__title">6. 광고 자산 연동(미연동 시)</div>
            <div class="node__meta">(운영자) CMC 매체별 광고 신청 / 연동 지원</div>
          </div>
          <div class="node" data-key="ops-7" style="grid-column:7">
            <div class="node__title">7. 후불 한도 확정</div>
            <div class="node__meta">한도 값 확정</div>
          </div>
          <div class="node" data-key="ops-8" style="grid-column:8">
            <div class="node__title">8. 후불 예산 반영</div>
            <div class="node__meta">예산 반영 결과 저장</div>
          </div>
          <div class="node" data-key="ops-9" style="grid-column:9">
            <div class="node__title">9. 차마솔 계정/시나리오 설정</div>
            <div class="node__meta">설정값 저장</div>
          </div>
          <div class="node" data-key="ops-10" style="grid-column:10">
            <div class="node__title">10. 세팅 검수 & 광고 ON</div>
            <div class="node__meta">최종 검수/ON</div>
          </div>
          <div class="node" data-key="ops-11" style="grid-column:11">
            <div class="node__title">11. 보고서 세팅</div>
            <div class="node__meta">CMC 광고보고서 세팅</div>
          </div>
          <div class="node" data-key="ops-12" style="grid-column:12">
            <div class="node__title">12. 월간 예산 루틴 반영</div>
            <div class="node__meta">대상 확인 후 반영</div>
          </div>
          <div class="node" data-key="ops-13" style="grid-column:13">
            <div class="node__title">13. 한도 재산정/증액 처리</div>
            <div class="node__meta">증액 적용/감액 적용</div>
          </div>
          <div class="node" data-key="ops-14" style="grid-column:14">
            <div class="node__title">14. 정산/미수금/추심</div>
            <div class="node__meta">미수금 대상 확인 → 광고 중단/추심</div>
          </div>
          <div class="node" data-key="ops-15" style="grid-column:15">
            <div class="node__title">15. 해지 처리</div>
            <div class="node__meta">중단→정산→해지</div>
          </div>
        </div>
      </section>

      <!-- 3) 시스템 동선 -->
      <section class="lane lane--system" data-lane="system">
        <div class="lane__label">시스템 동선
          <small>사람 작업과 별개로 시스템이 자동으로 수행/발송/판단하는 흐름(자동 노드)</small>
        </div>
        <div class="lane__body">
          <div class="node system" data-key="system-1" style="grid-column:1">
            <div class="node__title">대상자 선별 & 알림톡 발송</div>
            <div class="node__meta">조건 기반 대상자 생성 → 소개/가입 안내 발송 로그</div>
          </div>

          <div class="node system" data-key="system-3" style="grid-column:3">
            <div class="node__title">신청 접수 상태 관리(FAS 연계)</div>
            <div class="node__meta">신청 접수/완료 상태 업데이트 → 신청완료 안내 트리거</div>
          </div>

          <div class="node system" data-key="system-4" style="grid-column:4">
            <div class="node__title">업종 심사 결과 반영 & 진행불가 알림</div>
            <div class="node__meta">NO면 진행불가 발송 및 종료</div>
          </div>

          <div class="node system" data-key="system-5" style="grid-column:5">
            <div class="node__title">카드 등록 상태 체크 & 리마인드</div>
            <div class="node__meta">미등록: 등록요청 / 기등록: 사용안내</div>
          </div>

          <div class="node system" data-key="system-6" style="grid-column:6">
            <div class="node__title">광고자산 연동 상태 체크 & 요청/점검</div>
            <div class="node__meta">미연동: 연동요청 / 연동완료: 점검 단계 이동</div>
          </div>

          <div class="node system" data-key="system-9" style="grid-column:9">
            <div class="node__title">차마솔 광고 세팅 자동 수행</div>
            <div class="node__meta">운영자 설정값 입력 → 세팅 실행 → 결과 저장/발송 트리거</div>
          </div>

          <div class="node system" data-key="system-10" style="grid-column:10">
            <div class="node__title">차마솔 시나리오 정기 실행(운영 루틴)</div>
            <div class="node__meta">정기 실행 → 세팅/필터링 내역 생성/발송</div>
          </div>

          <div class="node system" data-key="system-11" style="grid-column:11">
            <div class="node__title">CMC 광고보고서 주간 생성(리포트 루틴)</div>
            <div class="node__meta">주간 생성 → 광고보고서 발송</div>
          </div>

          <div class="node system" data-key="system-14" style="grid-column:14">
            <div class="node__title">후불 정산(월 2회) & PG차감/미수금 분기</div>
            <div class="node__meta">PG차감 가능/불가 분기 + 카드결제 성공/실패 처리 + 중단/추심 알림 트리거</div>
          </div>
        </div>
      </section>

      <!-- 4) 후불계약 동선 (✅ 관련 단계 컬럼에 맞춰 재배치하여 화살표 길이 최소화) -->
      <section class="lane lane--contract" data-lane="contract">
        <div class="lane__label">후불계약 동선
          <small>후불 과금/한도/예산/정산/미수금/부속합의 중심 흐름</small>
        </div>
        <div class="lane__body">
          <!-- 1: 신청/동의 기반 = 고객2와 가까운 2열 -->
          <div class="node" data-key="contract-1" style="grid-column:2">
            <div class="node__title">1. 가입/동의 기반 형성</div>
            <div class="node__meta">PRO 마케팅 신청 & 약관 동의</div>
          </div>

          <!-- 2: 결제수단 = 고객5와 가까운 5열 -->
          <div class="node" data-key="contract-2" style="grid-column:5">
            <div class="node__title">2. 결제수단 확보</div>
            <div class="node__meta">카드 등록(미등록 시 등록 요청) / 기등록 카드 확인</div>
          </div>

          <!-- 3: 한도 확정 = 고객7과 가까운 7열 -->
          <div class="node" data-key="contract-3" style="grid-column:7">
            <div class="node__title">3. 한도 확정</div>
            <div class="node__meta">“후불 한도 확정 & 광고 세팅 안내”</div>
          </div>

          <!-- 4: 예산 반영 = 운영8과 가까운 8열 -->
          <div class="node" data-key="contract-4" style="grid-column:8">
            <div class="node__title">4. 예산 반영</div>
            <div class="node__meta">후불 예산 반영 상태 저장/알림</div>
          </div>

          <!-- 5: 월간 예산 반영(루틴) = 고객12/운영12와 가까운 12열 -->
          <div class="node" data-key="contract-5" style="grid-column:12">
            <div class="node__title">5. 월간 예산 반영(루틴)</div>
            <div class="node__meta">“후불 예산 반영 알림”</div>
          </div>

          <!-- 6~8: 재산정/부속합의/일예산 조정 = 고객13과 가까운 13열 -->
          <div class="node" data-key="contract-6" style="grid-column:13">
            <div class="node__title">6. 한도 재산정(월 1회)</div>
            <div class="node__meta">감액 안내 / 증액 시 부속합의 요청</div>
          </div>

          <div class="node" data-key="contract-7" style="grid-column:14">
            <div class="node__title">7. 증액 시 부속합의</div>
            <div class="node__meta">(몰어드민) 부속합의 요청 → 동의 → 완료 확인</div>
          </div>

          <div class="node" data-key="contract-8" style="grid-column:15">
            <div class="node__title">8. 일예산 조정</div>
            <div class="node__meta">동의(YES) 시 일예산 조정 트리거</div>
          </div>

          <!-- 9~11: 정산/미수금/해지정산 = 고객14~15와 가까운 14~15열 -->
          <div class="node" data-key="contract-9" style="grid-column:14">
            <div class="node__title">9. 정산(월 2회)</div>
            <div class="node__meta">정산금 산정 및 PG차감/미수금 분기</div>
          </div>

          <div class="node" data-key="contract-10" style="grid-column:15">
            <div class="node__title">10. 미수금 처리</div>
            <div class="node__meta">카드결제 시도/실패 시 중단·추심</div>
          </div>

          <div class="node" data-key="contract-11" style="grid-column:15">
            <div class="node__title">11. 해지 시 정산 완료</div>
            <div class="node__meta">해지 완료/정산 완료 상태 반영</div>
          </div>
        </div>
      </section>

    </div>
  </div>
</div>

<!-- Modal -->
<div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-label="상세 정보">
  <div class="modal">
    <div class="modalHeader">
      <div>
        <h2 id="modalTitle">상세</h2>
        <p id="modalSub">노드를 클릭하면 원문 상세를 볼 수 있습니다.</p>
      </div>
      <button class="closeBtn" id="closeBtn" type="button">닫기</button>
    </div>
    <div class="modalBody">
      <div class="detailGrid" id="modalBody"></div>
    </div>
  </div>
</div>

<script>
  // ====== 상세 데이터(모달) ======
  const DETAILS = {
    // 고객
    "customer-1": { title:"1. 안내 수신 후 신청 진입", cards:[
      ["고객 행동(동선)","안내 수신 후 신청 진입"],
      ["프론트(고객 접점)","(알림톡) PRO 마케팅 소개 & 가입 안내 수신"],
      ["시스템/백엔드(상태/데이터)","대상자 선별 결과 기반 발송 이력 저장"],
      ["사람개입(운영/CS)","문의 응대(선택)"],
    ]},
    "customer-2": { title:"2. 신청/약관 동의", cards:[
      ["프론트","(몰어드민) PRO 마케팅 신청 & 약관 동의"],
      ["백엔드","신청 접수, 신청 상태 생성/저장"],
      ["사람개입","신청 가이드(선택)"],
    ]},
    "customer-3": { title:"3. 신청 완료 확인", cards:[
      ["프론트","(알림톡) 신청완료 안내 수신"],
      ["백엔드","FAS 접수/상태 업데이트"],
      ["사람개입","모니터링"],
    ]},
    "customer-4": { title:"4. 업종 심사 결과 확인", cards:[
      ["프론트","(알림톡) 진행 불가 안내 수신(해당 시)"],
      ["백엔드","업종 심사 결과(YES/NO) 저장"],
      ["사람개입","ANPL팀 심사(진행불가 업종: 성인용품/이미테이션/기타)"],
    ]},
    "customer-5": { title:"5. 카드 등록 진행(필요 시)", cards:[
      ["프론트","(몰어드민) 광고 정보 확인 & 카드 등록 요청/기등록 안내, (알림톡) 카드등록 요청/기등록 카드 사용 안내"],
      ["백엔드","카드 등록여부 상태 관리, 완료 여부 업데이트"],
      ["사람개입","카드등록 문의 대응(선택)"],
    ]},
    "customer-6": { title:"6. 광고 자산 연동 요청/점검", cards:[
      ["프론트","(몰어드민) 광고 준비중 안내, (알림톡) 자산 연동 요청 또는 점검중 안내"],
      ["백엔드","자산 연동여부/완료 상태 업데이트"],
      ["사람개입","연동 지원/점검(선택)"],
    ]},
    "customer-7": { title:"7. 후불 한도/세팅 안내 확인", cards:[
      ["프론트","(알림톡) 후불 한도 확정 & 광고 세팅 안내 수신"],
      ["백엔드","후불 한도 값 확정/저장, 예산 반영 상태 저장"],
      ["사람개입","운영자 한도 확정/예산 반영"],
    ]},
    "customer-8": { title:"8. 광고계정 생성 확인", cards:[
      ["변경사항","기존 ‘라이브 상태 확인’ → ‘광고계정 생성 확인’으로 수정"],
      ["프론트","(몰어드민) 광고계정 생성 완료 확인 & 해지 버튼 노출"],
      ["백엔드","(필요 시) 광고계정 생성 완료 상태/전환 기록 저장"],
      ["사람개입","운영자 검수 후 ON (정책/프로세스에 따라)"],
    ]},
    "customer-9": { title:"9. 광고 시작/세팅 내역 수신", cards:[
      ["프론트","(알림톡/이메일) 광고 시작 안내 & 세팅 내역 수신"],
      ["백엔드","발송 이력/세팅 스냅샷 저장"],
    ]},
    "customer-10": { title:"10. 운영 루틴 결과 수신", cards:[
      ["프론트","(알림톡/이메일) 광고 세팅 & 필터링 내역 수신"],
      ["백엔드","차마솔 시나리오 정기 실행 결과 저장"],
      ["사람개입","이슈 대응(선택)"],
    ]},
    "customer-11": { title:"11. 주간 보고서 수신", cards:[
      ["프론트","(알림톡/이메일) 광고보고서 수신"],
      ["백엔드","CMC 광고보고서 주간 생성 결과 저장"],
      ["사람개입","보고서 세팅(운영자)"],
    ]},
    "customer-12": { title:"12. 월간 예산 반영 알림 수신", cards:[
      ["프론트","(알림톡) 후불 예산 반영 알림 수신"],
      ["백엔드","예산 반영 결과 저장"],
      ["사람개입","운영자 반영"],
    ]},
    "customer-13": { title:"13. 한도 재산정(증/감액) 대응", cards:[
      ["프론트","증액: 부속합의 요청/완료 확인 + 증액&일예산 조정 안내 / 감액: 감액 적용 안내"],
      ["백엔드","한도 증/감액 상태 저장, 증액은 부속합의 동의 결과 반영"],
      ["사람개입","증액/감액 적용(운영자), 일예산 조정(시스템)"],
    ]},
    "customer-14": { title:"14. 후불 정산/미수금 확인", cards:[
      ["프론트","(몰어드민) 정산/PG차감/미수금/카드결제 내역 확인 + (알림톡) 정산/미수금/실패&중단/추심 안내"],
      ["백엔드","정산금 산정, PG차감 vs 미수금 분기, 카드결제 시도 결과 저장"],
      ["사람개입","미수금 시 광고 중단/추심 진행(운영자)"],
    ]},
    "customer-15": { title:"15. 해지 요청/완료", cards:[
      ["프론트","(몰어드민) 1:1 문의/CTI 접수 → 해지&정산 안내/완료 확인 + (알림톡) 정산완료&해지완료"],
      ["백엔드","해지 상태 전환/정산 완료 처리"],
      ["사람개입","해지 요청 확인→광고중단→정산→해지 처리(운영자)"],
    ]},
  };

  // ====== 다이어그램 폭/높이 계산 ======
  function computeDiagramSize(){
    const root = getComputedStyle(document.documentElement);
    const labelW = parseFloat(root.getPropertyValue("--labelW"));
    const colW   = parseFloat(root.getPropertyValue("--colW"));
    const gap    = parseFloat(root.getPropertyValue("--gap"));
    const padX   = parseFloat(root.getPropertyValue("--padX"));
    const laneH  = parseFloat(root.getPropertyValue("--laneH"));
    const lanes  = document.querySelectorAll(".lane").length;

    const bodyW = (15 * colW) + (14 * gap) + (2 * padX);
    const totalW = labelW + bodyW;
    const totalH = lanes * laneH;

    const diagram = document.getElementById("diagram");
    diagram.style.width = totalW + "px";
    diagram.style.height = totalH + "px";

    const svg = document.getElementById("lines");
    svg.setAttribute("viewBox", `0 0 ${totalW} ${totalH}`);
    svg.setAttribute("width", totalW);
    svg.setAttribute("height", totalH);
  }

  // ====== 화살표 그리기 (DOM 좌표 기반, 노드 아래로 라우팅) ======
  function clearLines(){
    const svg = document.getElementById("lines");
    // defs는 남기고 path만 제거
    [...svg.querySelectorAll("path")].forEach(p => p.remove());
  }

  function relRect(el, container){
    const r = el.getBoundingClientRect();
    const c = container.getBoundingClientRect();
    return {
      left: r.left - c.left,
      top: r.top - c.top,
      right: r.right - c.left,
      bottom: r.bottom - c.top,
      width: r.width,
      height: r.height
    };
  }

  function laneRectForNode(node, container){
    const lane = node.closest(".lane");
    return relRect(lane, container);
  }

  // 가로(순차) 연결: 노드 아래 여백으로 통과
  function pathHorizontalBelow(fromEl, toEl, container){
    const a = relRect(fromEl, container);
    const b = relRect(toEl, container);
    const laneR = laneRectForNode(fromEl, container);

    // ✅ 노드 아래 y (lane 안에서 clamp)
    const yRaw = a.bottom + 16;
    const y = Math.min(yRaw, laneR.bottom - 14);

    const x1 = a.right;
    const x2 = b.left;

    const dx = Math.min(80, Math.max(28, (x2 - x1) * 0.25));
    return `M ${x1} ${y} C ${x1+dx} ${y}, ${x2-dx} ${y}, ${x2} ${y}`;
  }

  // 세로/교차 연결: 꺾어서 안전하게 (노드 위 통과 최소화)
  function pathOrthogonal(fromEl, toEl, container){
    const a = relRect(fromEl, container);
    const b = relRect(toEl, container);

    const x1 = a.left + a.width/2;
    const y1 = a.bottom;
    const x2 = b.left + b.width/2;
    const y2 = b.top;

    const vPad = 18;
    const midY = y1 + vPad;

    // 3-segment (down -> horizontal -> down/up)
    // 라운딩은 cubic로 간단 처리
    const r = 10;

    const p1 = {x:x1, y:y1};
    const p2 = {x:x1, y:midY};
    const p3 = {x:x2, y:midY};
    const p4 = {x:x2, y:y2};

    // 코너 라운드(간단)
    const d = [
      `M ${p1.x} ${p1.y}`,
      `L ${p2.x} ${p2.y - r}`,
      `C ${p2.x} ${p2.y} ${p2.x} ${p2.y} ${p2.x + (p3.x>p2.x ? r : -r)} ${p2.y}`,
      `L ${p3.x - (p3.x>p2.x ? r : -r)} ${p3.y}`,
      `C ${p3.x} ${p3.y} ${p3.x} ${p3.y} ${p3.x} ${p3.y + r}`,
      `L ${p4.x} ${p4.y}`
    ].join(" ");
    return d;
  }

  function addPath(d, cls, marker){
    const svg = document.getElementById("lines");
    const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
    p.setAttribute("d", d);
    p.setAttribute("class", cls);
    p.setAttribute("marker-end", marker);
    svg.appendChild(p);
  }

  function drawAllConnections(){
    const container = document.getElementById("diagram");
    clearLines();

    const get = (key) => document.querySelector(`.node[data-key="${key}"]`);

    // ✅ 연결 정의
    const connections = [];

    // (A) 각 레인 순차 연결 (가로, 노드 아래로)
    for(let i=1;i<=14;i++) connections.push({from:`customer-${i}`, to:`customer-${i+1}`, type:"h", style:"solid"});
    for(let i=1;i<=14;i++) connections.push({from:`ops-${i}`, to:`ops-${i+1}`, type:"h", style:"solid"});
    // 시스템은 일부만 존재(1,3,4,5,6,9,10,11,14)라서 있는 것만 순차 의미로 연결
    const sys = ["system-1","system-3","system-4","system-5","system-6","system-9","system-10","system-11","system-14"];
    for(let i=0;i<sys.length-1;i++) connections.push({from:sys[i], to:sys[i+1], type:"h", style:"dashed"});

    // (B) 후불(계약) 동선 연결: 실제 흐름 순서(짧게 유지되도록 컬럼 재배치됨)
    const con = ["contract-1","contract-2","contract-3","contract-4","contract-5","contract-6","contract-7","contract-8","contract-9","contract-10","contract-11"];
    for(let i=0;i<con.length-1;i++) connections.push({from:con[i], to:con[i+1], type:"h", style:"faint"});

    // (C) 레인 간 핵심 연결(후불 동선이 “다른 노드”에 실제로 연결되도록)
    connections.push({from:"customer-2", to:"contract-1", type:"o", style:"dashed"}); // 신청 ↔ 계약기반
    connections.push({from:"customer-5", to:"contract-2", type:"o", style:"dashed"}); // 카드 ↔ 결제수단
    connections.push({from:"customer-7", to:"contract-3", type:"o", style:"dashed"}); // 한도확정 ↔ 한도
    connections.push({from:"ops-8",      to:"contract-4", type:"o", style:"dashed"}); // 예산반영 ↔ 예산
    connections.push({from:"customer-12",to:"contract-5", type:"o", style:"dashed"}); // 월간 예산 알림 ↔ 루틴
    connections.push({from:"customer-13",to:"contract-6", type:"o", style:"dashed"}); // 재산정 ↔ 재산정
    connections.push({from:"customer-13",to:"contract-7", type:"o", style:"dashed"}); // 증액 ↔ 부속합의
    connections.push({from:"customer-13",to:"contract-8", type:"o", style:"dashed"}); // 일예산 ↔ 조정
    connections.push({from:"customer-14",to:"contract-9", type:"o", style:"dashed"}); // 정산 ↔ 정산
    connections.push({from:"customer-14",to:"contract-10",type:"o", style:"dashed"}); // 미수금 ↔ 처리
    connections.push({from:"customer-15",to:"contract-11",type:"o", style:"dashed"}); // 해지 ↔ 해지정산

    // 시스템 ↔ 고객/운영 일부 연결(짧은 컬럼 기반)
    connections.push({from:"system-5", to:"customer-5", type:"o", style:"faint"});
    connections.push({from:"system-6", to:"customer-6", type:"o", style:"faint"});
    connections.push({from:"system-9", to:"customer-9", type:"o", style:"faint"});
    connections.push({from:"system-14",to:"customer-14",type:"o", style:"faint"});
    connections.push({from:"system-14",to:"ops-14",     type:"o", style:"faint"});

    // ✅ 실제 렌더
    for(const c of connections){
      const fromEl = get(c.from);
      const toEl = get(c.to);
      if(!fromEl || !toEl) continue;

      if(c.type === "h"){
        const d = pathHorizontalBelow(fromEl, toEl, container);
        if(c.style === "dashed") addPath(d, "arrow dashed", "url(#arrowheadBlue)");
        else if(c.style === "faint") addPath(d, "arrow faint", "url(#arrowheadFaint)");
        else addPath(d, "arrow", "url(#arrowhead)");
      }else{
        const d = pathOrthogonal(fromEl, toEl, container);
        if(c.style === "dashed") addPath(d, "arrow dashed", "url(#arrowheadBlue)");
        else if(c.style === "faint") addPath(d, "arrow faint", "url(#arrowheadFaint)");
        else addPath(d, "arrow", "url(#arrowhead)");
      }
    }
  }

  // ====== 모달 ======
  const backdrop = document.getElementById("modalBackdrop");
  const closeBtn = document.getElementById("closeBtn");
  const modalTitle = document.getElementById("modalTitle");
  const modalSub = document.getElementById("modalSub");
  const modalBody = document.getElementById("modalBody");

  function openModal(key){
    const info = DETAILS[key];
    modalBody.innerHTML = "";

    if(!info){
      modalTitle.textContent = "상세 정보 없음";
      modalSub.textContent = "이 노드는 상세 데이터가 아직 연결되지 않았습니다.";
    }else{
      modalTitle.textContent = info.title;
      modalSub.textContent = "원문 기준 요약/구성";
      for(const [h, t] of info.cards){
        const card = document.createElement("div");
        card.className = "detailCard";
        card.innerHTML = `<h3>${h}</h3><pre>${t}</pre>`;
        modalBody.appendChild(card);
      }
    }

    backdrop.classList.add("show");
  }

  function closeModal(){
    backdrop.classList.remove("show");
  }

  document.querySelectorAll(".node").forEach(node=>{
    node.addEventListener("click", ()=>{
      const key = node.getAttribute("data-key");
      openModal(key);
    });
  });

  closeBtn.addEventListener("click", closeModal);
  backdrop.addEventListener("click", (e)=>{ if(e.target === backdrop) closeModal(); });
  document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeModal(); });

  // ====== 초기화 / 리사이즈 대응 ======
  function rerender(){
    computeDiagramSize();
    // 레이아웃 확정 후 한 프레임 뒤에 그리기(정확도↑)
    requestAnimationFrame(()=> drawAllConnections());
  }

  window.addEventListener("load", rerender);
  window.addEventListener("resize", rerender);
</script>
</body>
</html>
